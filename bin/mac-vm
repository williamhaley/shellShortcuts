#!/usr/bin/env bash

MY_OPTIONS="+aes,+xsave,+avx,+xsaveopt,avx2,+smep"

if [ -z "${1}" ];
then
	echo "Must specify path to macOS VM"
	exit 1
fi

DIR=$1

OVMF_CODE=$DIR/OVMF_CODE.fd
OVMF_VARS=$DIR/OVMF_VARS-1024x768.fd
CLOVER=$DIR/Clover.qcow2
MAC=52:54:00:c9:18:27
HDD=$DIR/mac_hdd.img

MY_OPTIONS="+aes,+xsave,+avx,+xsaveopt,avx2,+smep"

qemu-system-x86_64 -enable-kvm -m 3072 -cpu Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,$MY_OPTIONS\
	-machine pc-q35-2.9 \
	-smp 4,cores=2 \
	-usb -device usb-kbd -device usb-tablet \
	-device isa-applesmc,osk="ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc" \
	-drive if=pflash,format=raw,readonly,file="${OVMF_CODE}" \
	-drive if=pflash,format=raw,file="${OVMF_VARS}" \
	-smbios type=2 \
	-device ich9-intel-hda -device hda-duplex \
	-device ide-drive,bus=ide.2,drive=Clover \
	-drive id=Clover,if=none,snapshot=on,format=qcow2,file="${CLOVER}" \
	-device ide-drive,bus=ide.1,drive=MacHDD \
	-drive id=MacHDD,if=none,file="${HDD}",format=qcow2 \
	-netdev user,id=net0 -device e1000-82545em,netdev=net0,id=net0,mac="${MAC}" \
	-monitor stdio

#	-device ide-drive,bus=ide.0,drive=MacDVD \
#	-drive id=MacDVD,if=none,snapshot=on,media=cdrom,file=./'HighSierra-10.13.5.iso' \
