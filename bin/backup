#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

interrupt()
{
	echo "Script interrupted."
	exit 1
}

trap interrupt INT

do_rsync()
{
	rsync_opts="--delete-excluded --delete-after --exclude=node_modules --exclude=lost+found $3"

	echo "rsync: $1 ==> $2"
	echo ""
	wrsync ${rsync_opts} "$1" "$2"
	echo ""
}

do_rclone()
{
	rsync_opts="--delete-excluded --delete-after $3"

	echo "rclone: $1 ==> $2"
	echo ""
	sudo -u ${SUDO_USER:-$USER} wrclone sync ${rsync_opts} "$1" "$2"
	echo ""
}

do_horcrux()
{
	if ! `findmnt -M "/mnt/horcrux${1}" >/dev/null`;
	then
		echo "/mnt/horcrux${1} is not mounted"
	else
		echo "rclone: horcrux${1}"
		echo ""
		rsync -avr \
			/home/will/Documents \
			/home/will/.electrum \
			/home/will/keys \
			"/mnt/horcrux${1}/"
		echo ""
	fi
}

do_full()
{
	if ! `findmnt -M "/mnt/${1}" >/dev/null`;
	then
		echo "/mnt/${1} is not mounted. Skipping."
		return
	fi

	if ! `findmnt -M "/mnt/data" > /dev/null`;
	then
		echo "/mnt/data is not available. Skipping ${1}."
		return
	fi

	do_rsync /mnt/will-home/        "/mnt/${1}/willhaley-backup/"

	mkdir -p "/mnt/${1}/system-backup"
	do_rsync /etc/fstab             "/mnt/${1}/system-backup/"
	do_rsync /etc/crypttab          "/mnt/${1}/system-backup/"
	do_rsync /etc/default/grub      "/mnt/${1}/system-backup/"
	do_rsync /etc/default/cryptdisk "/mnt/${1}/system-backup/"

	do_rsync /mnt/data/ "/mnt/${1}/data/"
}

do_3tb()
{
	if ! `findmnt -M "/mnt/${1}" >/dev/null`;
	then
		echo "/mnt/${1} is not mounted. Skipping."
		return
	fi

	if ! `findmnt -M "/mnt/data" > /dev/null`;
	then
		echo "/mnt/data is not available. Skipping ${1}."
		return
	fi

	do_rsync /mnt/will-home/        "/mnt/${1}/willhaley-backup/"

	mkdir -p "/mnt/${1}/system-backup"
	do_rsync /etc/fstab             "/mnt/${1}/system-backup/"
	do_rsync /etc/crypttab          "/mnt/${1}/system-backup/"
	do_rsync /etc/default/grub      "/mnt/${1}/system-backup/"
	do_rsync /etc/default/cryptdisk "/mnt/${1}/system-backup/"

	do_rsync /mnt/data/ "/mnt/${1}/data/" --exclude=Renders
}

do_b2()
{
	do_rclone /home/will/Photographs/         "Backup:willhaley-backup/Photographs/"
	# No `Audio`. Subject to frequent metadata changes, and can be recovered from elsewhere.
	do_rclone /home/will/Software/            "Backup:willhaley-backup/Software/"

	# Encrypted
	do_rclone /home/will/keys/                "BackupCrypt:willhaley-backup/keys/"
	do_rclone /home/will/Documents/           "BackupCrypt:willhaley-backup/Documents/"
	do_rclone /mnt/data/FamilyBackups/        "BackupCrypt:willhaley-backup/FamilyBackups/"
	do_rclone /home/will/.electrum/           "BackupCrypt:willhaley-backup/electrum/"
}

do_full backup-internal
do_3tb backup-external-1
do_3tb backup-external-2
do_b2
do_horcrux 1
do_horcrux 2
do_horcrux 3

