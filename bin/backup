#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

interrupt()
{
	echo "Script interrupted."
	exit 1
}

trap interrupt INT

do_rsync()
{
	rsync_opts="--delete-excluded --delete-after --exclude=node_modules --exclude=lost+found $3"

	echo "rsync: $1 ==> $2"
	echo ""
	wrsync ${rsync_opts} "$1" "$2"
	echo ""
}

do_full()
{
	if ! `findmnt -M "/mnt/${1}" >/dev/null`;
	then
		echo "/mnt/${1} is not mounted. Skipping."
		return
	fi

	if ! `findmnt -M "/mnt/will-home" > /dev/null`;
	then
		echo "/mnt/will-home is not available. Skipping ${1}."
		return
	else
		do_rsync /mnt/will-home/ "/mnt/${1}/willhaley-backup/"
	fi

	mkdir -p "/mnt/${1}/system-backup"
	do_rsync /etc/fstab "/mnt/${1}/system-backup"
	do_rsync /etc/crypttab "/mnt/${1}/system-backup"
	do_rsync /etc/default/grub "/mnt/${1}/system-backup"
	do_rsync /etc/default/cryptdisk "/mnt/${1}/system-backup"
	do_rsync /etc/mkinitcpio.conf "/mnt/${1}/system-backup"

	if ! `findmnt -M "/mnt/data" > /dev/null`;
	then
		echo "/mnt/data is not available. Skipping ${1}."
		return
	else
		do_rsync /mnt/data/ "/mnt/${1}/data/"
	fi
}

do_full backup-internal
do_full backup-external-1
do_full backup-external-2
