#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

interrupt()
{
	echo "Script interrupted."
	exit 1
}

trap interrupt INT

do_rsync()
{
	rsync_opts="--itemize-changes --archive --recursive --verbose --progress --delete-excluded --delete-after"
	rsync_opts="${rsync_opts} --exclude=".localized" --exclude=".DS_Store" --exclude=node_modules --exclude=lost+found"

	#set -x
	#rsync_opts="${rsync_opts} --dry-run"

	echo "rsync: $1 ==> $2"
	echo ""
	rsync ${rsync_opts} "${@:3}" "$1" "$2"
	echo ""
}

_backup()
{
	dest_mnt="${1}"
	backup_level=${2}

	if ! `findmnt -M "${dest_mnt}" >/dev/null`;
	then
		echo "${dest_mnt} is not available."
		return
	fi

	# Level 1 - System configs. Very small. Size not an issue
	if [ ${backup_level} -ge 1 ];
	then
		mkdir -p "${dest_mnt}/system-backup"
		cp /etc/fstab             "${dest_mnt}/system-backup"
		cp /etc/crypttab          "${dest_mnt}/system-backup"
		cp /etc/default/grub      "${dest_mnt}/system-backup"
		cp /etc/mkinitcpio.conf   "${dest_mnt}/system-backup"
	fi

	# Level 2 - Home
	if [ ${backup_level} -ge 2 ];
	then
		if ! `findmnt -M "/mnt/will-home" > /dev/null`;
		then
			echo "/mnt/will-home is not available."
			return
		fi

		# By default exclude all large files
		extra_opts="--exclude=dev --exclude=Downloads --exclude=Software --exclude=Photographs --exclude=Audio"

		# Level 3 - Include photographs
		if [ ${backup_level} -ge 3 ];
		then
			extra_opts="--exclude=dev --exclude=Downloads --exclude=Software --exclude=Audio"
		fi

		# Level 4 - Include audio
		if [ ${backup_level} -ge 4 ];
		then
			extra_opts="--exclude=dev --exclude=Downloads --exclude=Software"
		fi

		# Level 5 - Everything in home directory
		if [ ${backup_level} -ge 5 ];
		then
			extra_opts=''
		fi

		do_rsync /mnt/will-home/ "${dest_mnt}/willhaley-backup/" ${extra_opts}
	fi

	# Level 6 - Data
	if [ ${backup_level} -ge 6 ];
	then
		if ! `findmnt -M "/mnt/data" > /dev/null`;
		then
			echo "/mnt/data is not available."
			return
		else
			extra_opts="--exclude=Videos/Renders"

			# Level 7 - Data (full)
			if [ ${backup_level} -ge 7 ];
			then
				extra_opts=''
			fi

			do_rsync /mnt/data/ "${dest_mnt}/data/" ${extra_opts}
		fi
	fi
}

_backup "/mnt/horcrux-1" 3
_backup "/mnt/horcrux-2" 3
_backup "/mnt/horcrux-3" 4
_backup "/mnt/backup-internal" 7
_backup "/mnt/backup-external-1" 6
_backup "/mnt/backup-external-2" 6

