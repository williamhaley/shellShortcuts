#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

if [ -n "${1}" ];
then
	if [ "${1}" = "--log" ];
	then
		if [ -n "${2}" ];
		then
			last=$(ls "$(real-home)/Logs/backup/" | tail -${2} | head -1)
		else
			last=$(ls "$(real-home)/Logs/backup/" | tail -1)
		fi

		echo "log file: ${last}"
		echo

		cat "$(real-home)/Logs/backup/${last}"
		exit 0
	else
		echo "--log is the only valid parameter"
		exit 1
	fi
fi

name="$(date-8601)"
log="$(real-home)/Logs/backup/${name}.log"

echo "log file: ${log}"
echo

mkdir -p "$(real-home)/Logs/backup"

interrupt()
{
	echo "Script interrupted."
	exit 1
}

trap interrupt INT

do_rsync()
{
	rsync_opts="--delete-excluded --delete-after --exclude=node_modules $3"

	echo "rsync: $1 ==> $2" | tee -a "${log}"
	echo "" >> "${log}"

	wrsync ${rsync_opts} "$1" "$2" >> "${log}" 2>&1

	echo "" >> "${log}"
}

do_rclone()
{
	rsync_opts="--delete-excluded --delete-after $3"

	echo "rclone: $1 ==> $2" | tee -a "${log}"
	echo "" >> "${log}"

	sudo -u ${SUDO_USER:-$USER} wrclone sync ${rsync_opts} "$1" "$2" >> "${log}" 2>&1

	echo "" >> "${log}"
}

do_horcrux()
{
	if ! `findmnt -M "/mnt/horcrux${1}" >/dev/null`;
	then
		echo "/mnt/horcrux${1} is not mounted"
	else
		echo "rclone: horcrux${1}" | tee -a "${log}"
		echo "" >> "${log}"

		rsync -avr \
			--include=Documents/*** \
			--include=.electrum/*** \
			--include=lost+found \
			--exclude=* \
			--delete-excluded \
			/home/will/ "/mnt/horcrux${1}/" >> "${log}" 2>&1

		echo "" >> "${log}"
	fi
}

do_full()
{
	if ! `findmnt -M "/mnt/${1}" >/dev/null`;
	then
		echo "/mnt/${1} is not mounted. Skipping."
		return
	fi

	if ! `findmnt -M "/mnt/data" > /dev/null`;
	then
		echo "/mnt/data is not available. Skipping ${1}."
		return
	fi

	do_rsync /mnt/will-home/        "/mnt/${1}/willhaley-backup/"

	do_rsync /etc/fstab             "/mnt/${1}/system-backup/fstab"
	do_rsync /etc/crypttab          "/mnt/${1}/system-backup/crypttab"
	do_rsync /etc/default/grub      "/mnt/${1}/system-backup/grub"
	do_rsync /etc/default/cryptdisk "/mnt/${1}/system-backup/cryptdisk"

	do_rsync /mnt/data/PlexDB/       "/mnt/${1}/PlexDB/"
	do_rsync /mnt/data/Videos/       "/mnt/${1}/Videos/"
}

do_b2()
{
	do_rclone /home/will/Photographs/         "Backup:willhaley-backup/Photographs/"
	# No `Music`. Subject to changes, and can be recovered from elsewhere.
	do_rclone /home/will/Software/            "Backup:willhaley-backup/Software/"
	do_rclone /home/will/Documents/           "BackupCrypt:willhaley-backup/Documents/"
	do_rclone /home/will/.electrum/           "BackupCrypt:willhaley-backup/electrum/"
}

do_backup_family_photos()
{
	do_rclone "GoogleDrive:Google Photos/" "/home/will/FamilyPhotos/" --drive-shared-with-me
}

do_backup_family_photos
do_full backup-internal
do_full backup-external
do_b2
do_horcrux 1
do_horcrux 2
do_horcrux 3
