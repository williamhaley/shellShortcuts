#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

interrupt()
{
	echo "Script interrupted."
	exit 1
}

trap interrupt INT

do_rsync()
{
	rsync_opts="--delete-excluded --delete-after --exclude=node_modules --exclude=lost+found $3"

	echo "rsync: $1 ==> $2"
	echo ""
	wrsync ${rsync_opts} "$1" "$2"
	echo ""
}

_backup()
{
	dest_mnt="${1}"
	backup_level=${2}

	if ! `findmnt -M "${dest_mnt}" >/dev/null`;
	then
		echo "${dest_mnt} is not available."
		return
	fi

	# Level 1 - System configs
	if [ ${backup_level} -ge 1 ];
	then
		mkdir -p "${dest_mnt}/system-backup"
		cp /etc/fstab             "${dest_mnt}/system-backup"
		cp /etc/crypttab          "${dest_mnt}/system-backup"
		cp /etc/default/grub      "${dest_mnt}/system-backup"
		cp /etc/mkinitcpio.conf   "${dest_mnt}/system-backup"
	fi

	# Level 2 - Home (minimal)
	if [ ${backup_level} -ge 2 ];
	then
		if ! `findmnt -M "/mnt/will-home" > /dev/null`;
		then
			echo "/mnt/will-home is not available."
			return
		fi

		home_include_exclude="--include="Documents/***" --include="keys/***" --include=".electrum/***" --exclude="*""

		# Level 3 - Home (full)
		if [ ${backup_level} -ge 3 ];
		then
			home_include_exclude=''
		fi

		rsync -avr \
			--delete --delete-excluded --delete-after \
			${home_include_exclude} \
			--exclude=node_modules --exclude=lost+found \
			/mnt/will-home/ \
			"${dest_mnt}/willhaley-backup/"
	fi

	# Level 4 - Data
	if [ ${backup_level} -gt 4 ];
	then
		if ! `findmnt -M "/mnt/data" > /dev/null`;
		then
			echo "/mnt/data is not available."
			return
		else
			do_rsync /mnt/data/ "${dest_mnt}/data/"
		fi
	fi
}

_backup "/mnt/horcrux-3" 2
_backup "/mnt/backup-internal" 4
_backup "/mnt/backup-external-1" 4
_backup "/mnt/backup-external-2" 4
