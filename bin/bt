#!/usr/bin/env bash

[ $EUID -ne 0 ] && echo "run as root" >&2 && exit 1

device=BSK10

sudo systemctl stop bluetooth

sleep 2

sudo systemctl start bluetooth

sleep 2

sudo -u `real-user` pulseaudio --kill

sleep 2

sudo -u `real-user` pulseaudio --start

sleep 2

command()
{
	echo "$@" | sudo -u `real-user` bluetoothctl
}

if [ -n "$1" ]
then
	command "$@"
	exit
fi

command "power off"
command "power on"
command "scan on"

# check list of devices. make sure we have a valid mac for our device.
mac=$(
	echo devices | \
		sudo bluetoothctl | \
		grep ${device} | \
		awk '{print $2;}' | \
		grep -i '[0-9A-F]\{2\}\(:[0-9A-F]\{2\}\)\{5\}'
)

echo "mac ${mac}"

sleep 2

command "pair ${mac}"
command "connect ${mac}"

#connected=$(echo "info ${mac}" | sudo bluetoothctl | awk '/Connected/{print $2;}')
#if [ "${connected}" = "yes" ];
#then
#	break
#fi

card=$(printf "bluez_card.${mac}" | sed s/:/_/g)

echo "switching pulseaudio to card ${card}"

pacmd set-card-profile "${card}" a2dp_sink

